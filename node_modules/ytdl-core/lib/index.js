var http        = require('http');
var PassThrough = require('stream').PassThrough;
var request     = require('request');
var _           = require('underscore');
var getInfo     = require('./info');
var crequest    = require('./crequest');
var util        = require('./util');

module.exports = ytdl;
ytdl.getInfo = getInfo;
ytdl.downloadFromInfo = downloadFromInfo;

/**
 * @param {String} link
 * @param {Object} options
 * @return {ReadableStream}
 */
function ytdl(link, options, callback) {
  options = options || {};
  options.downloadURL = true;

  var stream = new PassThrough();

  getInfo(link, options, function(err, info) {
    if (err) {
      stream.emit('error', err);
      return;
    }

    downloadFromInfoCallback(info, options, function(url) {
      callback(url)
    });
  });

  return stream;
}

function downloadFromInfoCallback(info, options, callback) {
  options = options || {};

  var format = util.chooseFormat(info.formats, options);
  if (format instanceof Error) {
    // The caller expects this function to be async.
    setImmediate(callbackWithFormatError);
    return;
  }

  var requestOptions = _.clone(options);
  requestOptions.url = format.url;
  if (requestOptions.range) {
    requestOptions.url += '&range=' + requestOptions.range;
  }
  delete requestOptions.quality;
  delete requestOptions.range;
  delete requestOptions.filter;

  callback(requestOptions);
}

function downloadFromInfo(info, options) {
  var stream = new PassThrough();
  options = options || {};

  downloadFromInfoCallback(info, options, function(err, format, videoStream) {
    if (err) {
      stream.emit('error', err);
      return;
    }

    stream.emit('format', format);
    videoStream.pipe(stream);
  });

  return stream;
}
